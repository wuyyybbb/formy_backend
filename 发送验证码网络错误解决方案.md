# 发送验证码网络错误解决方案

## 🔍 **问题现象**

**错误提示**: "网络连接失败，请检查网络"

**Network 面板显示**:
- 请求状态: **Stalled** (被阻塞)
- Connection Start: Stalled
- 请求 URL: `https://formy-backend.onrender.com/api/v1/auth/send-code`

---

## 🎯 **根本原因**

### **原因 1: Render 免费版服务休眠（90%可能）**

**Render 免费版限制**:
- 15 分钟无活动后自动休眠
- 休眠后第一次请求需要 30-60 秒唤醒
- 唤醒期间所有请求都会超时失败

**识别方法**:
- 请求显示 "Stalled" 状态
- 长时间没有响应
- 30秒后才有反应

### **原因 2: CORS 配置问题（10%可能）**

虽然代码已更新，但环境变量可能未生效。

---

## ✅ **解决方案（按优先级）**

### **🔥 方案 1: 唤醒 Render 服务（推荐，最快）**

#### 步骤 1: 访问后端 API 文档
在浏览器新标签页打开：
```
https://formy-backend.onrender.com/docs
```

#### 步骤 2: 等待加载
- ⏰ 第一次加载需要 **30-60 秒**
- 看到进度条或加载中提示，不要关闭
- 加载完成后会显示 Swagger API 文档界面

#### 步骤 3: 返回前端重试
1. 返回前端登录页面
2. 刷新页面（F5）
3. 重新输入邮箱
4. 点击"发送验证码"
5. ✅ 应该在 2-3 秒内收到响应

---

### **🔧 方案 2: 检查 Render 环境变量**

#### 1. 登录 Render Dashboard
https://dashboard.render.com/

#### 2. 进入后端服务
找到 **formy_backend** 服务

#### 3. 检查环境变量
点击左侧 **"Environment"** 标签，确认以下变量：

```bash
# 必须包含以下变量
REDIS_URL=redis://red-xxxxxxxxxxxxx:6379
RESEND_API_KEY=re_xxxxxxxxxxxxxxxxxxxxx
CORS_ORIGINS=https://formy-frontend.vercel.app,http://localhost:5173
SECRET_KEY=<你的密钥>
```

**特别检查 CORS_ORIGINS**:
- ✅ 必须包含 `https://formy-frontend.vercel.app`
- ⚠️ 注意是 `https://` 不是 `http://`
- ⚠️ 没有结尾的斜杠 `/`

#### 4. 如果环境变量错误
1. 点击 "Edit" 修改
2. 保存后等待自动重新部署（2-3分钟）

---

### **🔍 方案 3: 查看后端日志**

#### 1. 进入 Logs 标签
Render Dashboard → formy_backend → **Logs**

#### 2. 查看最新日志

**✅ 正常日志**:
```
✅ Redis 连接成功！
🔧 邮件服务初始化: API Key: 已配置
```

**❌ 错误日志**:
```
❌ Redis 连接失败
或
❌ RESEND_API_KEY 未设置
```

#### 3. 如果看到错误
- Redis 错误 → 检查 REDIS_URL
- 邮件服务错误 → 检查 RESEND_API_KEY

---

### **⚡ 方案 4: 测试后端 API（高级）**

#### 使用浏览器直接测试

1. 打开浏览器控制台（F12）

2. 在 Console 中执行：
```javascript
fetch('https://formy-backend.onrender.com/api/v1/auth/send-code', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    email: 'test@example.com'
  })
})
.then(response => {
  console.log('Status:', response.status);
  return response.json();
})
.then(data => console.log('Response:', data))
.catch(error => console.error('Error:', error));
```

3. 查看结果：

**✅ 成功**:
```javascript
Status: 200
Response: {success: true, message: "验证码已发送到 test@example.com", expires_in: 600}
```

**❌ CORS 错误**:
```
Access to fetch at '...' from origin '...' has been blocked by CORS policy
```
→ 需要更新 CORS_ORIGINS 环境变量

**❌ 超时/Stalled**:
```
Failed to fetch
```
→ Render 服务休眠，使用方案 1 唤醒

---

## 🚀 **快速修复步骤（推荐）**

### 1️⃣ 唤醒服务（30秒）
```
访问: https://formy-backend.onrender.com/docs
等待: 30-60秒
看到: Swagger API 文档
```

### 2️⃣ 测试验证码（10秒）
```
返回前端 → 刷新页面 → 输入邮箱 → 发送验证码
```

### 3️⃣ 检查结果
- ✅ 成功：看到验证码输入界面
- ❌ 失败：查看 Network 标签的错误详情

---

## 📊 **错误类型与解决方案对照表**

| 错误现象 | 原因 | 解决方案 |
|---------|------|---------|
| **Stalled 30秒+** | Render 休眠 | 访问 /docs 唤醒服务 |
| **CORS policy error** | CORS 配置错误 | 更新 CORS_ORIGINS 环境变量 |
| **500 Internal Server** | Redis/邮件配置错误 | 查看后端日志，检查环境变量 |
| **404 Not Found** | API 路径错误 | 检查前端 API_BASE_URL |
| **Network Error** | 服务宕机 | 查看 Render Dashboard 服务状态 |

---

## 🔍 **详细诊断步骤**

### 步骤 1: 检查 Render 服务状态
1. 登录 Render Dashboard
2. 查看 formy_backend 服务
3. 状态应该是 **"Live"** (绿色)
4. 如果是 **"Sleeping"** → 访问 /docs 唤醒

### 步骤 2: 检查前端 API 配置
打开浏览器控制台，查看请求的 URL：
```
应该是: https://formy-backend.onrender.com/api/v1/auth/send-code
不应该是: http://localhost:8000/...
```

### 步骤 3: 检查浏览器控制台错误
查看 Console 标签，可能的错误：
- CORS 错误 → 更新 CORS_ORIGINS
- Network 错误 → 服务未响应
- Timeout 错误 → 服务休眠

### 步骤 4: 检查 Network 标签详情
点击失败的请求，查看：
- **Headers**: 检查 Request Headers
- **Response**: 查看错误响应内容
- **Timing**: 查看请求耗时

---

## 🎯 **防止服务休眠的方法**

### 方法 1: 升级到付费版（最彻底）
- Render Starter Plan: $7/月
- 永不休眠

### 方法 2: 使用定时 Ping（免费）
使用第三方服务定时访问您的后端：

**UptimeRobot**（推荐）:
1. 访问: https://uptimerobot.com/
2. 免费注册
3. 添加监控: `https://formy-backend.onrender.com/docs`
4. 设置检查间隔: 每 5 分钟
5. ✅ 服务将保持唤醒状态

**Cron-job.org**:
1. 访问: https://cron-job.org/
2. 创建定时任务
3. URL: `https://formy-backend.onrender.com/`
4. 间隔: 每 10 分钟

### 方法 3: 前端预加载（开发环境）
在前端首页加载时就请求后端：
```typescript
useEffect(() => {
  // 预加载后端，避免首次请求超时
  fetch('https://formy-backend.onrender.com/docs')
    .catch(() => {});
}, []);
```

---

## ✅ **验证修复成功**

### 1. 后端响应正常
- ✅ 请求耗时 < 5 秒
- ✅ 状态码 200
- ✅ 返回 `{success: true, ...}`

### 2. 前端显示正常
- ✅ 切换到验证码输入界面
- ✅ 显示 6 位数字输入框
- ✅ 倒计时 60 秒开始

### 3. 邮件发送成功
- ✅ 收到验证码邮件（检查垃圾箱）
- ✅ 邮件显示 6 位数字验证码

---

## 🆘 **仍然无法解决？**

### 收集以下信息：

1. **后端日志截图**
   - Render Dashboard → Logs 标签
   - 复制最近 50 行日志

2. **浏览器 Network 截图**
   - F12 → Network 标签
   - 显示失败请求的详细信息

3. **环境变量截图**
   - Render Dashboard → Environment 标签
   - 隐藏敏感信息（如密钥）

4. **错误信息**
   - 前端错误提示文字
   - Console 的错误信息

---

## 📞 **常见问题 FAQ**

### Q1: 为什么每次第一次请求都很慢？
**A**: Render 免费版会休眠，建议使用 UptimeRobot 定时 Ping

### Q2: CORS 错误如何解决？
**A**: 确保 CORS_ORIGINS 环境变量包含 `https://formy-frontend.vercel.app`

### Q3: 500 错误是什么原因？
**A**: 通常是 Redis 或邮件配置问题，查看后端日志

### Q4: 如何知道 Redis 配置正确？
**A**: 后端日志显示 "✅ Redis 连接成功！"

### Q5: 验证码邮件没收到？
**A**: 检查：1) 垃圾箱 2) RESEND_API_KEY 3) 后端日志

---

## 🎉 **最快解决方案总结**

**99% 的情况只需要做这个**:

1. 打开新标签页：`https://formy-backend.onrender.com/docs`
2. 等待 30-60 秒
3. 返回前端刷新页面
4. 重新发送验证码
5. ✅ 成功！

---

**更新时间**: 2025-11-20  
**问题**: 发送验证码显示"网络连接失败"  
**核心原因**: Render 免费版服务休眠  
**解决方案**: 访问 /docs 唤醒服务

