# 任务轮询功能测试指南

## 🎯 功能概述

本次实现了完整的任务轮询功能，形成了完整的闭环：

**上传图片 → 创建任务 → Worker 处理 → 前端轮询 → 展示结果**

## ✅ 已实现的功能

### 前端
1. ✅ **useTaskPolling Hook** - 智能轮询任务状态
   - 每 2.5 秒自动查询任务状态
   - 根据状态自动停止轮询（DONE/FAILED/CANCELLED）
   - 支持 onUpdate、onComplete、onError 回调

2. ✅ **实时进度显示** - PreviewPanel 和 MobilePreview
   - 显示百分比进度条
   - 显示当前处理步骤
   - 平滑的过渡动画

3. ✅ **结果展示** - 任务完成后自动显示结果图片

### 后端
1. ✅ **简易 Worker** - `backend/run_worker_simple.py`
   - 模拟任务处理过程
   - 逐步更新进度（10% → 25% → 40% → 60% → 80% → 95% → 100%）
   - 每个步骤间隔 2 秒
   - 最终标记任务为 DONE

## 🧪 完整测试步骤

### 1. 启动后端 API

打开**第一个终端**：

```bash
cd F:\formy\backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**确认启动成功**：
- 访问 http://localhost:8000/health
- 应该返回 `{"status":"healthy"}`

### 2. 启动 Worker

打开**第二个终端**：

```bash
cd F:\formy\backend
python run_worker_simple.py
```

**确认启动成功**，应该看到：

```
    ╔══════════════════════════════════════════════════════════╗
    ║                                                          ║
    ║              Formy Worker - 简易版本                     ║
    ║                                                          ║
    ║  此 Worker 会模拟处理任务，逐步更新进度                   ║
    ║  用于开发测试，不执行真实的 AI 处理                       ║
    ║                                                          ║
    ╚══════════════════════════════════════════════════════════╝

🚀 Worker 已启动，等待任务...
按 Ctrl+C 停止
```

### 3. 启动前端

打开**第三个终端**：

```bash
cd F:\formy\frontend
npm run dev
```

前端应该运行在 http://localhost:5173

### 4. 测试完整流程

#### 步骤 A：准备图片
1. 打开浏览器访问 http://localhost:5173/editor
2. 打开浏览器开发者工具（F12），切换到 Console 标签

#### 步骤 B：上传图片
1. 点击"原始图片"上传区域，选择一张图片
2. 等待上传完成
3. 如果是 HEAD_SWAP 或 POSE_CHANGE 模式，也上传参考图片

#### 步骤 C：创建任务并观察轮询
1. 点击"开始生成"按钮
2. 观察以下现象：

**前端变化**：
- ✅ 按钮变为"处理中..."
- ✅ 右侧预览区域显示加载动画
- ✅ 进度条开始出现并逐渐增长
- ✅ 显示当前处理步骤（如"正在加载图片..."）

**控制台输出**：
```javascript
图片上传成功: { file_id: "img_20231117_xxx", ... }
任务创建成功，开始轮询: { task_id: "task_20231117_xxx", ... }
任务状态更新: { task_id: "...", status: "processing", progress: 10, ... }
任务状态更新: { task_id: "...", status: "processing", progress: 25, ... }
任务状态更新: { task_id: "...", status: "processing", progress: 40, ... }
...
✅ 任务完成: { task_id: "...", status: "done", result: {...} }
```

**Worker 终端输出**：
```
============================================================
开始处理任务: task_20231117_xxx
模式: HEAD_SWAP
============================================================

✅ 状态更新: PROCESSING
📊 进度更新: 10% - 正在加载图片...
📊 进度更新: 25% - 正在分析图像特征...
📊 进度更新: 40% - 正在进行 AI 处理...
📊 进度更新: 60% - 正在优化细节...
📊 进度更新: 80% - 正在生成结果...
📊 进度更新: 95% - 正在保存图片...

🎉 任务完成: task_20231117_xxx
结果: {'output_image': '/results/task_20231117_xxx_result.jpg', ...}
============================================================
```

#### 步骤 D：查看结果
1. 任务完成后（大约 12 秒）
2. 前端自动停止轮询
3. 右侧显示结果图片（当前是模拟的，会显示原图）
4. 进度显示消失

### 5. 测试不同场景

#### 场景 1：切换模式测试
- 切换到"AI 换背景"模式
- 上传图片并生成
- 观察是否正常工作

#### 场景 2：快速连续测试
- 创建一个任务
- 立即再创建另一个任务
- 观察 Worker 是否按顺序处理

#### 场景 3：刷新页面
- 创建任务后，等待几秒
- 刷新浏览器页面
- 观察：任务状态会丢失（这是正常的，因为没有持久化）

## 📊 成功标志

如果看到以下情况，说明轮询功能正常：

### 前端表现
✅ 点击生成后，立即显示"处理中"状态  
✅ 进度条从 0% 逐渐增长到 100%  
✅ 当前步骤文字不断更新  
✅ 大约 12 秒后，显示结果图片  
✅ 结果显示后，不再发起轮询请求（可在 Network 标签确认）  

### 后端表现
✅ Worker 终端显示任务处理日志  
✅ 进度从 10% → 95% 逐步更新  
✅ 最终标记任务为 DONE  

### 控制台输出
✅ 每 2.5 秒打印一次"任务状态更新"  
✅ 进度百分比逐渐增加  
✅ 最后打印"✅ 任务完成"  

## 🔍 调试技巧

### 查看轮询请求
1. 打开开发者工具 → Network 标签
2. 筛选 XHR 请求
3. 应该看到每 2.5 秒发送一次 `GET /api/v1/tasks/{task_id}`
4. 任务完成后，请求停止

### 查看任务详情
使用 API 文档手动查询：
1. 访问 http://localhost:8000/docs
2. 找到 `GET /api/v1/tasks/{task_id}`
3. 输入 task_id 查询
4. 查看完整的任务信息

### Worker 不工作？
检查：
- Redis 是否正在运行（如果配置了 Redis）
- Worker 终端是否有错误信息
- 任务是否真的被创建（查 API 文档）

## 📝 轮询机制说明

### 轮询流程
```
创建任务 (status = PENDING)
    ↓
Worker 开始处理 (status = PROCESSING)
    ↓
前端每 2.5 秒查询一次
    ├─ PENDING → 继续轮询
    ├─ PROCESSING → 更新进度，继续轮询
    ├─ DONE → 显示结果，停止轮询 ✅
    ├─ FAILED → 显示错误，停止轮询 ❌
    └─ CANCELLED → 停止轮询 ⚠️
```

### 轮询特性
- **智能停止**：任务完成后自动停止，不浪费资源
- **进度更新**：实时显示处理进度和当前步骤
- **错误处理**：网络错误不会中断轮询，会继续尝试
- **组件卸载安全**：页面离开时自动清理定时器

### 回调机制
```typescript
useTaskPolling({
  taskId: currentTaskId,
  interval: 2500,
  
  // 每次轮询都触发（包括 PENDING 和 PROCESSING）
  onUpdate: (task) => {
    setProgress(task.progress)
    setCurrentStep(task.current_step)
  },
  
  // 任务完成时触发（status = DONE）
  onComplete: (task) => {
    setResultImage(task.result.output_image)
    setIsProcessing(false)
  },
  
  // 任务失败时触发（status = FAILED）
  onError: (task) => {
    setErrorMessage(task.error.message)
    setIsProcessing(false)
  }
})
```

## 🚧 当前限制

### 已知限制
1. **结果图片是模拟的** - Worker 返回的路径不是真实文件
2. **刷新页面丢失状态** - 没有持久化，需要后续添加
3. **没有真实 AI 处理** - 只是模拟，需要后续接入真实 Pipeline

### 这些是正常的
这些限制是预期的，因为：
- 真实的图片处理将在 Pipeline 集成后实现
- 状态持久化是后续优化项
- 当前重点是验证轮询机制

## 🎉 完成！

你现在已经实现了完整的闭环：

**✅ 上传图片** → 获得 file_id  
**✅ 创建任务** → 任务进入队列  
**✅ Worker 处理** → 模拟 AI 处理，更新进度  
**✅ 前端轮询** → 实时显示进度  
**✅ 展示结果** → 任务完成后显示结果  

## 📊 性能数据

### 完整流程耗时
- 上传图片：< 1 秒
- 创建任务：< 0.5 秒
- Worker 处理：约 12 秒（模拟）
- 轮询间隔：2.5 秒
- 总轮询次数：约 5-6 次

### 网络请求
- POST /api/v1/upload：1 次（每张图片）
- POST /api/v1/tasks：1 次
- GET /api/v1/tasks/{task_id}：5-6 次（轮询）

## 🚀 下一步工作

1. **集成真实 Pipeline** - 接入真实的 AI 图像处理
2. **结果图片处理** - 真实保存和展示处理后的图片
3. **错误重试机制** - 网络失败时的重试策略
4. **任务历史记录** - 持久化任务列表
5. **任务列表页面** - 查看所有历史任务

---

**测试愉快！** 🎉

如果遇到问题，请检查：
1. 三个进程都在运行（API + Worker + Frontend）
2. 浏览器控制台是否有错误
3. Worker 终端是否显示任务处理日志

