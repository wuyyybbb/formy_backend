# æ•°æ®åº“è¿ç§»æŒ‡å— - ä»»åŠ¡ç³»ç»Ÿä» Redis è¿ç§»åˆ° PostgreSQL

## ğŸ“‹ æ¦‚è¿°

æœ¬æ¬¡è¿ç§»å°†ä»»åŠ¡æ•°æ®ä» Redis è¿ç§»åˆ° Supabase PostgreSQLï¼Œæé«˜æ•°æ®æŒä¹…æ€§å’ŒæŸ¥è¯¢æ€§èƒ½ã€‚

### è¿ç§»èŒƒå›´
- âœ… **ç”¨æˆ·æ•°æ®** - å·²ä» Redis è¿ç§»åˆ° PostgreSQLï¼ˆusers è¡¨ï¼‰
- âœ… **ä»»åŠ¡æ•°æ®** - ä» Redis è¿ç§»åˆ° PostgreSQLï¼ˆtasks è¡¨ï¼‰
- âš ï¸ **ä»»åŠ¡é˜Ÿåˆ—** - ä¿æŒä½¿ç”¨ Redisï¼ˆç”¨äº worker ä»»åŠ¡è°ƒåº¦ï¼‰

---

## ğŸ—ƒï¸ æ•°æ®åº“è¡¨ç»“æ„

### Tasks è¡¨
```sql
-- è¿è¡Œæ­¤ SQL åœ¨ Supabase ä¸­åˆ›å»ºè¡¨
-- æ–‡ä»¶ä½ç½®: backend/database_schema/tasks_table.sql
```

ä¸»è¦å­—æ®µï¼š
- `task_id` - ä»»åŠ¡IDï¼ˆä¸»é”®ï¼‰
- `user_id` - ç”¨æˆ·IDï¼ˆå…³è” users è¡¨ï¼‰
- `status` - ä»»åŠ¡çŠ¶æ€ï¼ˆpending/processing/done/failed/cancelledï¼‰
- `mode` - ç¼–è¾‘æ¨¡å¼ï¼ˆHEAD_SWAP/BACKGROUND_CHANGE/POSE_CHANGEï¼‰
- `source_image` - æºå›¾ç‰‡ file_id
- `reference_image` - å‚è€ƒå›¾ç‰‡ file_id
- `config` - é…ç½®å‚æ•°ï¼ˆJSONBï¼‰
- `result` - ä»»åŠ¡ç»“æœï¼ˆJSONBï¼‰
- `error` - é”™è¯¯ä¿¡æ¯ï¼ˆJSONBï¼‰
- `credits_consumed` - æ¶ˆè€—çš„ç®—åŠ›
- `created_at`, `updated_at`, `completed_at`, `failed_at` - æ—¶é—´æˆ³

---

## ğŸš€ è¿ç§»æ­¥éª¤

### 1. åœ¨ Supabase ä¸­åˆ›å»º tasks è¡¨

```bash
# 1. ç™»å½• Supabase Dashboard
# 2. é€‰æ‹©ä½ çš„é¡¹ç›®
# 3. è¿›å…¥ SQL Editor
# 4. å¤åˆ¶å¹¶è¿è¡Œ backend/database_schema/tasks_table.sql æ–‡ä»¶å†…å®¹
```

### 2. ç¡®è®¤ç¯å¢ƒå˜é‡é…ç½®

ç¡®ä¿ Render ä¸Šé…ç½®äº† `DATABASE_URL`ï¼š

```bash
DATABASE_URL=postgresql://postgres.[project-ref]:[password]@aws-0-[region].pooler.supabase.com:6543/postgres
```

### 3. é‡å¯ Render æœåŠ¡

```bash
# åœ¨ Render Dashboard ä¸­
# 1. è¿›å…¥ä½ çš„ Web Service
# 2. ç‚¹å‡» "Manual Deploy" -> "Deploy latest commit"
# æˆ–ä½¿ç”¨ Render API/CLI é‡å¯
```

### 4. éªŒè¯è¿ç§»

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯æ•°æ®åº“è¿æ¥å’ŒåŠŸèƒ½ï¼š

```bash
# åœ¨æœ¬åœ°æµ‹è¯•ï¼ˆéœ€è¦é…ç½® DATABASE_URLï¼‰
python -m pytest backend/tests/test_database.py

# æˆ–æ‰‹åŠ¨æµ‹è¯• API
curl -X POST "https://your-backend.onrender.com/api/v1/tasks" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "mode": "HEAD_SWAP",
    "source_image": "file_abc123",
    "config": {}
  }'
```

---

## ğŸ“ ä»£ç å˜æ›´è¯´æ˜

### 1. æ–°å¢æ–‡ä»¶

#### `backend/app/db/crud_tasks.py`
ä»»åŠ¡çš„æ•°æ®åº“ CRUD æ“ä½œï¼š
- `create_task()` - åˆ›å»ºä»»åŠ¡
- `get_task_by_id()` - è·å–ä»»åŠ¡è¯¦æƒ…
- `get_tasks_by_user()` - è·å–ç”¨æˆ·ä»»åŠ¡åˆ—è¡¨ï¼ˆæ”¯æŒç­›é€‰ã€åˆ†é¡µï¼‰
- `update_task_status()` - æ›´æ–°ä»»åŠ¡çŠ¶æ€
- `delete_task()` - åˆ é™¤ä»»åŠ¡
- `count_tasks_by_user()` - ç»Ÿè®¡ä»»åŠ¡æ•°é‡

#### `backend/database_schema/tasks_table.sql`
Tasks è¡¨çš„å»ºè¡¨ SQL è„šæœ¬

### 2. æ›´æ–°çš„æ–‡ä»¶

#### `backend/app/services/tasks/manager.py`
- `create_task()` - å†™å…¥æ•°æ®åº“ + æ¨å…¥ Redis é˜Ÿåˆ—
- `get_task()` - ä»æ•°æ®åº“è¯»å–
- `get_task_list()` - ä»æ•°æ®åº“æŸ¥è¯¢ï¼ˆæ”¯æŒç­›é€‰å’Œåˆ†é¡µï¼‰
- `update_task_progress()` - æ›´æ–°æ•°æ®åº“
- `complete_task()` - æ›´æ–°æ•°æ®åº“
- `fail_task()` - æ›´æ–°æ•°æ®åº“
- `cancel_task()` - æ›´æ–°æ•°æ®åº“

#### `backend/app/api/v1/routes_tasks.py`
- ä¿æŒè·¯ç”±é€»è¾‘ä¸å˜
- åº•å±‚é€šè¿‡ TaskService ä½¿ç”¨æ•°æ®åº“

---

## ğŸ”„ æ•°æ®æµæ¶æ„

### æ–°æ¶æ„ï¼ˆæ•°æ®åº“ + Redis é˜Ÿåˆ—ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Frontend (Vercel)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Backend API (Render)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  POST /api/v1/tasks                            â”‚    â”‚
â”‚  â”‚  1. åˆ›å»ºä»»åŠ¡ â†’ PostgreSQL (æŒä¹…åŒ–)             â”‚    â”‚
â”‚  â”‚  2. æ¨å…¥é˜Ÿåˆ— â†’ Redis (task_queue)              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  GET /api/v1/tasks/{id}                        â”‚    â”‚
â”‚  â”‚  â†’ PostgreSQL æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                             â”‚
                 â–¼                             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   PostgreSQL       â”‚         â”‚   Redis Queue    â”‚
    â”‚   (Supabase)       â”‚         â”‚   (Upstash)      â”‚
    â”‚                    â”‚         â”‚                  â”‚
    â”‚  â€¢ users è¡¨        â”‚         â”‚  task_queue â†â”   â”‚
    â”‚  â€¢ tasks è¡¨        â”‚         â”‚              â”‚   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”˜
                                                  â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚      Worker Process            â”‚
    â”‚  1. ä» Redis è·å–ä»»åŠ¡ID         â”‚
    â”‚  2. å¤„ç†ä»»åŠ¡                    â”‚
    â”‚  3. æ›´æ–°çŠ¶æ€ â†’ PostgreSQL       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®ç‚¹è¯´æ˜

1. **PostgreSQL (Supabase)** - æŒä¹…åŒ–å­˜å‚¨
   - å­˜å‚¨æ‰€æœ‰ä»»åŠ¡æ•°æ®ï¼ˆçŠ¶æ€ã€è¾“å…¥ã€è¾“å‡ºã€æ—¶é—´æˆ³ï¼‰
   - æ”¯æŒå¤æ‚æŸ¥è¯¢ï¼ˆæŒ‰ç”¨æˆ·ã€çŠ¶æ€ã€æ¨¡å¼ç­›é€‰ï¼‰
   - æä¾›å†å²è®°å½•å’Œæ•°æ®åˆ†æ

2. **Redis (Upstash)** - ä»»åŠ¡é˜Ÿåˆ—
   - ä»…ç”¨äºä»»åŠ¡è°ƒåº¦ï¼ˆtask_queueï¼‰
   - Worker ä»é˜Ÿåˆ—è·å–å¾…å¤„ç†ä»»åŠ¡
   - æä¾›å¿«é€Ÿçš„å…¥é˜Ÿ/å‡ºé˜Ÿæ“ä½œ

3. **æ··åˆæ¶æ„ä¼˜åŠ¿**
   - PostgreSQLï¼šæ•°æ®æŒä¹…åŒ–ã€å¤æ‚æŸ¥è¯¢
   - Redisï¼šé«˜æ€§èƒ½é˜Ÿåˆ—ã€å®æ—¶è°ƒåº¦

---

## ğŸ§ª æµ‹è¯•æ¸…å•

### API æµ‹è¯•

- [ ] **åˆ›å»ºä»»åŠ¡** - POST /api/v1/tasks
  - ä»»åŠ¡å†™å…¥æ•°æ®åº“
  - ä»»åŠ¡IDæ¨å…¥ Redis é˜Ÿåˆ—
  - è¿”å›æ­£ç¡®çš„ä»»åŠ¡ä¿¡æ¯

- [ ] **æŸ¥è¯¢ä»»åŠ¡** - GET /api/v1/tasks/{task_id}
  - ä»æ•°æ®åº“è¯»å–ä»»åŠ¡
  - æƒé™æ£€æŸ¥ï¼ˆåªèƒ½æŸ¥çœ‹è‡ªå·±çš„ä»»åŠ¡ï¼‰
  - è¿”å›å®Œæ•´ä»»åŠ¡ä¿¡æ¯

- [ ] **ä»»åŠ¡åˆ—è¡¨** - GET /api/v1/tasks
  - ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ä»»åŠ¡
  - æ”¯æŒçŠ¶æ€ç­›é€‰
  - æ”¯æŒåˆ†é¡µ

- [ ] **ä»»åŠ¡å†å²** - GET /api/v1/tasks/history
  - è¿”å›ä»»åŠ¡å†å²è®°å½•
  - åŒ…å« face_image_url å’Œ target_image_url
  - æ”¯æŒå‰ç«¯å›å¡«

- [ ] **å–æ¶ˆä»»åŠ¡** - POST /api/v1/tasks/{task_id}/cancel
  - æ›´æ–°æ•°æ®åº“çŠ¶æ€ä¸º cancelled
  - ä» Redis é˜Ÿåˆ—ç§»é™¤

### Worker æµ‹è¯•

- [ ] Worker ä» Redis è·å–ä»»åŠ¡
- [ ] Worker æ›´æ–°æ•°æ®åº“çŠ¶æ€ï¼ˆprocessing/done/failedï¼‰
- [ ] ä»»åŠ¡å¤±è´¥æ—¶é€€æ¬¾ç®—åŠ›
- [ ] ä»»åŠ¡å®Œæˆæ—¶ä¿å­˜ç»“æœåˆ°æ•°æ®åº“

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å‘åå…¼å®¹æ€§

ä»£ç ä¿ç•™äº† Redis å…¼å®¹æ€§ï¼š
- ä»ä» Redis è¯»å– user_id è¿›è¡Œæƒé™æ£€æŸ¥
- Redis ä¸­çš„æ—§ä»»åŠ¡æ•°æ®å¯ä»¥ç»§ç»­è®¿é—®

### 2. æ•°æ®ä¸€è‡´æ€§

- ä»»åŠ¡åˆ›å»ºï¼šå…ˆå†™æ•°æ®åº“ï¼Œå†å…¥é˜Ÿåˆ—
- ä»»åŠ¡æ›´æ–°ï¼šåŒæ—¶æ›´æ–°æ•°æ®åº“å’Œ Redisï¼ˆå¯é€‰ï¼‰
- å¦‚æœæ•°æ®åº“å†™å…¥å¤±è´¥ï¼Œæ•´ä¸ªæ“ä½œå›æ»š

### 3. æ€§èƒ½ä¼˜åŒ–

æ•°æ®åº“ç´¢å¼•ï¼š
- `idx_tasks_user_id` - æŒ‰ç”¨æˆ·æŸ¥è¯¢
- `idx_tasks_user_status` - æŒ‰ç”¨æˆ·å’ŒçŠ¶æ€æŸ¥è¯¢
- `idx_tasks_user_created` - æŒ‰ç”¨æˆ·å’Œæ—¶é—´æ’åºï¼ˆå†å²è®°å½•ï¼‰

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥

```bash
[DB] âŒ åˆ›å»ºæ•°æ®åº“è¿æ¥æ± å¤±è´¥: ...
```

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥ `DATABASE_URL` ç¯å¢ƒå˜é‡
2. ç¡®è®¤ Supabase é¡¹ç›®åœ¨çº¿
3. æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™

### é—®é¢˜ï¼šä»»åŠ¡åˆ›å»ºå¤±è´¥

```bash
Failed to create task: cannot push to queue
```

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥ Redis è¿æ¥
2. ç¡®è®¤ `REDIS_URL` ç¯å¢ƒå˜é‡
3. æŸ¥çœ‹ Redis é˜Ÿåˆ—é•¿åº¦

### é—®é¢˜ï¼šä»»åŠ¡çŠ¶æ€ä¸æ›´æ–°

```bash
Task status not updating in database
```

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥ Worker æ˜¯å¦è¿è¡Œ
2. æŸ¥çœ‹ Worker æ—¥å¿—
3. ç¡®è®¤æ•°æ®åº“è¿æ¥æ­£å¸¸

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### å…³é”®æ—¥å¿—ç‚¹

1. **ä»»åŠ¡åˆ›å»º**
   ```
   âœ“ ç®—åŠ›æ‰£é™¤æˆåŠŸï¼Œå‰©ä½™ X ç®—åŠ›
   âœ“ Task created successfully: task_xxx, Credits: Y
   ```

2. **ä»»åŠ¡å¤„ç†**
   ```
   [Worker] è·å–åˆ°ä»»åŠ¡: task_xxx
   [Worker] å¼€å§‹å¤„ç†ä»»åŠ¡ task_xxx - æ¨¡å¼: HEAD_SWAP
   [Worker] ä»»åŠ¡å®Œæˆ: task_xxx
   ```

3. **æ•°æ®åº“æ“ä½œ**
   ```
   [DB] âœ… PostgreSQL è¿æ¥æ± åˆ›å»ºæˆåŠŸ
   [DB] ğŸ“Š æ•°æ®åº“ç‰ˆæœ¬: PostgreSQL 15.x
   ```

### æ•°æ®åº“æŸ¥è¯¢ç¤ºä¾‹

```sql
-- æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡
SELECT task_id, user_id, status, mode, created_at 
FROM tasks 
ORDER BY created_at DESC 
LIMIT 10;

-- ç»Ÿè®¡å„çŠ¶æ€ä»»åŠ¡æ•°é‡
SELECT status, COUNT(*) 
FROM tasks 
GROUP BY status;

-- æŸ¥çœ‹æŸç”¨æˆ·çš„ä»»åŠ¡
SELECT * 
FROM tasks 
WHERE user_id = 'usr_xxx' 
ORDER BY created_at DESC;
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Supabase æ–‡æ¡£](https://supabase.com/docs)
- [asyncpg æ–‡æ¡£](https://magicstack.github.io/asyncpg/)
- [Redis é˜Ÿåˆ—è®¾è®¡](backend/TASK_SYSTEM_README.md)
- [API è§„èŒƒ](docs/API_SPEC.md)

---

## âœ… è¿ç§»å®Œæˆæ ‡å¿—

- [x] Tasks è¡¨åˆ›å»ºæˆåŠŸ
- [x] crud_tasks.py å®ç°å®Œæˆ
- [x] TaskService æ›´æ–°å®Œæˆ
- [x] routes_tasks.py æ›´æ–°å®Œæˆ
- [ ] åœ¨ Supabase è¿è¡Œå»ºè¡¨ SQL
- [ ] åœ¨ Render é…ç½® DATABASE_URL
- [ ] é‡å¯æœåŠ¡å¹¶éªŒè¯
- [ ] å‰ç«¯å†å²åŠŸèƒ½æµ‹è¯•é€šè¿‡

---

**æœ€åæ›´æ–°**: 2025-12-08
**ç‰ˆæœ¬**: 1.0.0
