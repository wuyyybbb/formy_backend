==================================================
  å¿«é€Ÿæµ‹è¯•ç®—åŠ›æ‰£å‡åŠŸèƒ½
==================================================

ğŸ“‹ å‰ææ¡ä»¶
-----------
1. åç«¯æ­£åœ¨è¿è¡Œï¼š
   cd backend
   python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

2. Redis æ­£åœ¨è¿è¡Œ


ğŸ§ª æ–¹æ³• 1: è‡ªåŠ¨æµ‹è¯•è„šæœ¬ï¼ˆæ¨èï¼‰âœ¨
-----------
cd backend
python test_credits_integration.py

æµ‹è¯•åœºæ™¯ï¼š
âœ“ åœºæ™¯ 1: ç®—åŠ›å……è¶³ â†’ ä»»åŠ¡åˆ›å»ºæˆåŠŸ
âœ“ åœºæ™¯ 2: ç®—åŠ›ä¸è¶³ â†’ è¿”å› 402 é”™è¯¯
âœ“ åœºæ™¯ 3: ä¸åŒæ¨¡å¼æ¶ˆè€—ä¸åŒç®—åŠ›

é¢„æœŸç»“æœï¼š
- åˆ›å»ºä»»åŠ¡æ—¶ä¼šæ‰£é™¤ç®—åŠ›
- ç®—åŠ›ä¸è¶³æ—¶è¿”å› 402 é”™è¯¯
- ä¸åŒä»»åŠ¡ç±»å‹æ¶ˆè€—ä¸åŒç®—åŠ›


ğŸ’» æ–¹æ³• 2: æ‰‹åŠ¨æµ‹è¯•ï¼ˆPowerShellï¼‰
-----------
# Step 1: ç™»å½•è·å– token
$email = "test@example.com"

Invoke-RestMethod -Uri "http://localhost:8000/api/v1/auth/send-code" -Method Post -Body (@{email=$email} | ConvertTo-Json) -ContentType "application/json"

$loginResponse = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/auth/login" -Method Post -Body (@{email=$email;code="YOUR_CODE"} | ConvertTo-Json) -ContentType "application/json"
$token = $loginResponse.access_token
$headers = @{Authorization="Bearer $token"}

# Step 2: åˆ‡æ¢åˆ° PRO å¥—é¤ï¼ˆ12000 ç®—åŠ›ï¼‰
Invoke-RestMethod -Uri "http://localhost:8000/api/v1/billing/change_plan" -Method Post -Headers $headers -Body (@{plan_id="pro"} | ConvertTo-Json) -ContentType "application/json" | ConvertTo-Json

# Step 3: æŸ¥çœ‹å½“å‰ç®—åŠ›
Invoke-RestMethod -Uri "http://localhost:8000/api/v1/billing/me" -Method Get -Headers $headers | ConvertTo-Json

# Step 4: åˆ›å»ºä»»åŠ¡ï¼ˆä¼šæ‰£é™¤ç®—åŠ›ï¼‰
$taskData = @{
    mode = "HEAD_SWAP"
    source_image = "test_image_123"
    config = @{
        quality = "standard"
        size = "medium"
    }
} | ConvertTo-Json

$task = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/tasks" -Method Post -Headers $headers -Body $taskData -ContentType "application/json"
Write-Host "ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼æ¶ˆè€—ç®—åŠ›: $($task.credits_consumed)"

# Step 5: å†æ¬¡æŸ¥çœ‹ç®—åŠ›ï¼ˆåº”è¯¥å‡å°‘äº†ï¼‰
Invoke-RestMethod -Uri "http://localhost:8000/api/v1/billing/me" -Method Get -Headers $headers | ConvertTo-Json

# Step 6: æµ‹è¯•ç®—åŠ›ä¸è¶³ï¼ˆæ¶ˆè€—åˆ°åªå‰© 30 ç®—åŠ›ï¼‰
Invoke-RestMethod -Uri "http://localhost:8000/api/v1/billing/consume_credits?amount=11970" -Method Post -Headers $headers

# Step 7: å°è¯•åˆ›å»ºä»»åŠ¡ï¼ˆéœ€è¦ 48ï¼Œä½†åªå‰© 30ï¼‰
try {
    Invoke-RestMethod -Uri "http://localhost:8000/api/v1/tasks" -Method Post -Headers $headers -Body $taskData -ContentType "application/json"
} catch {
    Write-Host "âœ“ æ­£ç¡®è¿”å›ç®—åŠ›ä¸è¶³é”™è¯¯ï¼ˆ402ï¼‰"
    $_.ErrorDetails.Message | ConvertFrom-Json | ConvertTo-Json -Depth 10
}


ğŸ“Š ç®—åŠ›æ¶ˆè€—å‚è€ƒ
-----------
æ ‡å‡†é…ç½®ï¼ˆquality=standard, size=mediumï¼‰ï¼š

AI æ¢å¤´ï¼ˆHEAD_SWAPï¼‰:          48 ç®—åŠ›
AI æ¢èƒŒæ™¯ï¼ˆBACKGROUND_CHANGEï¼‰: 36 ç®—åŠ›
AI æ¢å§¿åŠ¿ï¼ˆPOSE_CHANGEï¼‰:       60 ç®—åŠ›

ä¸åŒå¥—é¤å¯ç”¨æ¬¡æ•°ï¼š
- STARTERï¼ˆ2000ï¼‰:   çº¦ 41 æ¬¡æ¢å¤´
- BASICï¼ˆ5000ï¼‰:     çº¦ 104 æ¬¡æ¢å¤´
- PROï¼ˆ12000ï¼‰:      çº¦ 250 æ¬¡æ¢å¤´
- ULTIMATEï¼ˆ30000ï¼‰: çº¦ 625 æ¬¡æ¢å¤´


ğŸ¯ æµ‹è¯•è¦ç‚¹
-----------
1. åˆ›å»ºä»»åŠ¡éœ€è¦ç™»å½•ï¼ˆéœ€è¦ tokenï¼‰
2. åˆ›å»ºä»»åŠ¡å‰ä¼šæ£€æŸ¥ç®—åŠ›æ˜¯å¦è¶³å¤Ÿ
3. ç®—åŠ›è¶³å¤Ÿ â†’ ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼Œæ‰£é™¤ç®—åŠ›
4. ç®—åŠ›ä¸è¶³ â†’ è¿”å› 402 é”™è¯¯ï¼Œä¸åˆ›å»ºä»»åŠ¡
5. ä¸åŒæ¨¡å¼å’Œé…ç½®æ¶ˆè€—ä¸åŒç®—åŠ›
6. TaskInfo å“åº”ä¸­åŒ…å« credits_consumed å­—æ®µ


âŒ å¸¸è§é”™è¯¯
-----------
é”™è¯¯ç  401: token æ— æ•ˆæˆ–è¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•
é”™è¯¯ç  402: ç®—åŠ›ä¸è¶³ï¼Œéœ€è¦å……å€¼æˆ–å‡çº§å¥—é¤
é”™è¯¯ç  404: ç”¨æˆ·ä¸å­˜åœ¨ï¼Œéœ€è¦å…ˆç™»å½•
é”™è¯¯ç  500: æœåŠ¡å™¨é”™è¯¯


âœ… é¢„æœŸå“åº”ç¤ºä¾‹
-----------
åˆ›å»ºä»»åŠ¡æˆåŠŸï¼ˆ200ï¼‰ï¼š
{
  "task_id": "task_abc123",
  "status": "pending",
  "mode": "HEAD_SWAP",
  "credits_consumed": 48,
  ...
}

ç®—åŠ›ä¸è¶³ï¼ˆ402ï¼‰ï¼š
{
  "detail": {
    "error": "CREDIT_NOT_ENOUGH",
    "message": "ç®—åŠ›ä¸è¶³ã€‚éœ€è¦ 48 ç®—åŠ›ï¼Œå½“å‰å‰©ä½™ 30 ç®—åŠ›",
    "required": 48,
    "current": 30,
    "deficit": 18
  }
}


ğŸ” Swagger UI æµ‹è¯•
-----------
1. æ‰“å¼€ http://localhost:8000/docs
2. å…ˆç™»å½•è·å– tokenï¼ˆauth æ ‡ç­¾ï¼‰
3. ç‚¹å‡» ğŸ”“ Authorizeï¼Œè¾“å…¥ Bearer YOUR_TOKEN
4. æ‰¾åˆ° billing æ ‡ç­¾ï¼š
   - GET /billing/me - æŸ¥çœ‹ç®—åŠ›
   - POST /billing/change_plan - åˆ‡æ¢å¥—é¤
5. æ‰¾åˆ° tasks æ ‡ç­¾ï¼š
   - POST /tasks - åˆ›å»ºä»»åŠ¡ï¼ˆä¼šæ‰£é™¤ç®—åŠ›ï¼‰


ğŸ“š ç›¸å…³æ–‡æ¡£
-----------
- è¯¦ç»†å®ç°è¯´æ˜ï¼šç®—åŠ›æ‰£å‡ä¸AIä»»åŠ¡é›†æˆè¯´æ˜.md
- ç®—åŠ›æ¶ˆè€—é…ç½®ï¼šbackend/app/config/credits_cost.py
- API æ–‡æ¡£ï¼šhttp://localhost:8000/docs


ğŸ’¡ æç¤º
-----------
- MVP é˜¶æ®µä¸æ¥å…¥çœŸå®æ”¯ä»˜ï¼Œå¯ä»¥ç›´æ¥åˆ‡æ¢å¥—é¤
- ç®—åŠ›æ‰£å‡æ˜¯"é¢„æ‰£é™¤"æœºåˆ¶ï¼Œä»»åŠ¡åˆ›å»ºå¤±è´¥ä¼šè‡ªåŠ¨è¿”è¿˜
- å‰ç«¯åº”è¯¥åœ¨ç”¨æˆ·ç‚¹å‡»"ç”Ÿæˆ"å‰æ˜¾ç¤ºé¢„ä¼°ç®—åŠ›æ¶ˆè€—
- å»ºè®®åœ¨å‰ç«¯æ˜¾ç¤ºå®æ—¶å‰©ä½™ç®—åŠ›

