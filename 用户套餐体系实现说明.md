# ç”¨æˆ·å¥—é¤ä½“ç³»å®ç°è¯´æ˜

## âœ… å®Œæˆå†…å®¹

å·²å®ç°ç”¨æˆ·ä½“ç³»ä¸å¥—é¤ç»‘å®šï¼ŒåŒ…æ‹¬ç®—åŠ›ç®¡ç†ã€å¥—é¤åˆ‡æ¢ç­‰åŠŸèƒ½ã€‚

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ user.py                        # User æ¨¡å‹ï¼ˆå·²æ‰©å±•ï¼‰
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â””â”€â”€ billing.py                     # è®¡è´¹ç›¸å…³ Pydantic æ¨¡å‹
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ billing/
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â””â”€â”€ billing_service.py         # è®¡è´¹æœåŠ¡
â”‚   â”œâ”€â”€ api/v1/
â”‚   â”‚   â””â”€â”€ routes_billing.py              # è®¡è´¹ API è·¯ç”±
â”‚   â””â”€â”€ main.py                            # æ³¨å†Œè·¯ç”±
â””â”€â”€ test_billing_api.py                    # API æµ‹è¯•è„šæœ¬
```

---

## ğŸ¯ æ ¸å¿ƒå®ç°

### 1. ç”¨æˆ·æ¨¡å‹æ‰©å±•ï¼ˆ`backend/app/models/user.py`ï¼‰

åœ¨åŸæœ‰ `User` æ¨¡å‹åŸºç¡€ä¸Šï¼Œæ–°å¢äº†å¥—é¤å’Œç®—åŠ›ç›¸å…³å­—æ®µï¼š

```python
class User(BaseModel):
    # ... åŸæœ‰å­—æ®µ ...
    
    # å¥—é¤å’Œç®—åŠ›ç›¸å…³å­—æ®µï¼ˆæ–°å¢ï¼‰
    current_plan_id: Optional[str]          # å½“å‰å¥—é¤ID
    current_credits: int                    # å½“å‰å‰©ä½™ç®—åŠ›
    plan_renew_at: Optional[datetime]       # ä¸‹æ¬¡ç»­è´¹æ—¶é—´
    total_credits_used: int                 # ç´¯è®¡ä½¿ç”¨ç®—åŠ›
```

### 2. è®¡è´¹æ¨¡å‹ï¼ˆ`backend/app/schemas/billing.py`ï¼‰

å®šä¹‰äº† 3 ä¸ªæ ¸å¿ƒæ¨¡å‹ï¼š

#### UserBillingInfo - ç”¨æˆ·è®¡è´¹ä¿¡æ¯
```python
{
  "user_id": "user_123",
  "email": "user@example.com",
  "current_plan_id": "pro",
  "current_plan_name": "PRO",
  "current_credits": 8500,              # å‰©ä½™ç®—åŠ›
  "monthly_credits": 12000,             # æ¯æœˆæ€»é¢
  "total_credits_used": 35000,          # ç´¯è®¡ä½¿ç”¨
  "plan_renew_at": "2025-12-01T00:00:00",
  "credits_usage_percentage": 29.17     # ä½¿ç”¨ç™¾åˆ†æ¯”
}
```

#### ChangePlanRequest - åˆ‡æ¢å¥—é¤è¯·æ±‚
```python
{
  "plan_id": "pro"  # starter / basic / pro / ultimate
}
```

#### ChangePlanResponse - åˆ‡æ¢å¥—é¤å“åº”
```python
{
  "success": true,
  "message": "æˆåŠŸåˆ‡æ¢åˆ° PRO å¥—é¤",
  "new_plan_id": "pro",
  "new_plan_name": "PRO",
  "new_credits": 12000,
  "plan_renew_at": "2025-12-01T00:00:00"
}
```

### 3. è®¡è´¹æœåŠ¡ï¼ˆ`backend/app/services/billing/billing_service.py`ï¼‰

æä¾›æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼š

#### æ ¸å¿ƒæ–¹æ³•

| æ–¹æ³• | åŠŸèƒ½ | è¯´æ˜ |
|------|------|------|
| `get_user(user_id)` | è·å–ç”¨æˆ· | ä» Redis è¯»å– |
| `save_user(user)` | ä¿å­˜ç”¨æˆ· | å­˜å…¥ Redis |
| `get_user_billing_info(user_id)` | è·å–è®¡è´¹ä¿¡æ¯ | åŒ…å«å¥—é¤ã€ç®—åŠ›ç­‰ |
| `change_plan(user_id, plan_id)` | åˆ‡æ¢å¥—é¤ | æ›´æ–°å¥—é¤ã€é‡ç½®ç®—åŠ› |
| `consume_credits(user_id, amount)` | æ¶ˆè€—ç®—åŠ› | æ‰£é™¤ç®—åŠ› |
| `add_credits(user_id, amount)` | å¢åŠ ç®—åŠ› | å……å€¼ã€èµ é€ç­‰ |
| `check_and_renew_plan(user_id)` | æ£€æŸ¥å¹¶ç»­è´¹ | è‡ªåŠ¨ç»­è´¹é€»è¾‘ |

#### ç®—åŠ›ç®¡ç†é€»è¾‘

**åˆ‡æ¢å¥—é¤æ—¶**ï¼š
1. éªŒè¯å¥—é¤æ˜¯å¦å­˜åœ¨
2. æ›´æ–°ç”¨æˆ·çš„ `current_plan_id`
3. é‡ç½®ç®—åŠ›ä¸ºæ–°å¥—é¤çš„æœˆåº¦é¢åº¦
4. è®¾ç½®ä¸‹æ¬¡ç»­è´¹æ—¶é—´ï¼ˆä¸‹ä¸ªæœˆ 1 å·ï¼‰

**æ¶ˆè€—ç®—åŠ›æ—¶**ï¼š
1. æ£€æŸ¥ç®—åŠ›æ˜¯å¦è¶³å¤Ÿ
2. æ‰£é™¤ç®—åŠ› `current_credits -= amount`
3. ç´¯è®¡ä½¿ç”¨ `total_credits_used += amount`

**ç»­è´¹æ—¶**ï¼ˆåˆ°æœŸè‡ªåŠ¨ï¼‰ï¼š
1. æ£€æŸ¥æ˜¯å¦åˆ°è¾¾ `plan_renew_at`
2. é‡ç½®ç®—åŠ›ä¸ºå¥—é¤æœˆåº¦é¢åº¦
3. æ›´æ–°ä¸‹æ¬¡ç»­è´¹æ—¶é—´ï¼ˆ+1 ä¸ªæœˆï¼‰

### 4. è®¡è´¹ APIï¼ˆ`backend/app/api/v1/routes_billing.py`ï¼‰

æä¾› 2 ä¸ªä¸»è¦æ¥å£ + 2 ä¸ªå†…éƒ¨æ¥å£ï¼š

---

## ğŸ“ API æ¥å£è¯¦è§£

### API 1: è·å–è®¡è´¹ä¿¡æ¯ â­

```http
GET /api/v1/billing/me
Authorization: Bearer <token>
```

**åŠŸèƒ½**ï¼šè·å–å½“å‰ç”¨æˆ·çš„å¥—é¤å’Œç®—åŠ›ä¿¡æ¯

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "user_id": "user_abc123",
  "email": "user@example.com",
  "current_plan_id": "pro",
  "current_plan_name": "PRO",
  "current_credits": 8500,
  "monthly_credits": 12000,
  "total_credits_used": 35000,
  "plan_renew_at": "2025-12-01T00:00:00",
  "credits_usage_percentage": 29.17
}
```

**å‰ç«¯å¯ä»¥ç”¨è¿™ä¸ªæ¥å£**ï¼š
- æ˜¾ç¤ºç”¨æˆ·å½“å‰å¥—é¤
- æ˜¾ç¤ºå‰©ä½™ç®—åŠ›
- æ˜¾ç¤ºç®—åŠ›è¿›åº¦æ¡
- æ˜¾ç¤ºä¸‹æ¬¡ç»­è´¹æ—¶é—´

---

### API 2: åˆ‡æ¢å¥—é¤ â­

```http
POST /api/v1/billing/change_plan
Authorization: Bearer <token>
Content-Type: application/json

{
  "plan_id": "pro"
}
```

**åŠŸèƒ½**ï¼šåˆ‡æ¢ç”¨æˆ·å¥—é¤ï¼ˆMVP é˜¶æ®µä¸æ¥å…¥çœŸå®æ”¯ä»˜ï¼‰

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "message": "æˆåŠŸåˆ‡æ¢åˆ° PRO å¥—é¤",
  "new_plan_id": "pro",
  "new_plan_name": "PRO",
  "new_credits": 12000,
  "plan_renew_at": "2025-12-01T00:00:00"
}
```

**MVP é˜¶æ®µè¯´æ˜**ï¼š
- âœ… ä¸æ¥å…¥çœŸå®æ”¯ä»˜
- âœ… ç‚¹å‡»"é€‰æ‹©æ–¹æ¡ˆ"ç›´æ¥åˆ‡æ¢
- âœ… ç®—åŠ›ç«‹å³é‡ç½®ä¸ºæ–°å¥—é¤é¢åº¦
- âœ… æ–¹ä¾¿æµ‹è¯•å’Œæ¼”ç¤º

---

### API 3: æ¶ˆè€—ç®—åŠ›ï¼ˆå†…éƒ¨æ¥å£ï¼‰

```http
POST /api/v1/billing/consume_credits?amount=100
Authorization: Bearer <token>
```

**åŠŸèƒ½**ï¼šæ¶ˆè€—ç”¨æˆ·ç®—åŠ›ï¼ˆä»»åŠ¡å¤„ç†æ—¶è°ƒç”¨ï¼‰

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "remaining_credits": 7900
}
```

---

### API 4: å¢åŠ ç®—åŠ›ï¼ˆå†…éƒ¨æ¥å£ï¼‰

```http
POST /api/v1/billing/add_credits?amount=500
Authorization: Bearer <token>
```

**åŠŸèƒ½**ï¼šå¢åŠ ç”¨æˆ·ç®—åŠ›ï¼ˆå……å€¼ã€èµ é€ç­‰ï¼‰

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "total_credits": 8400
}
```

---

## ğŸ§ª æµ‹è¯•æŒ‡å—

### æ–¹æ³• 1: ä½¿ç”¨æµ‹è¯•è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
cd backend
python test_billing_api.py
```

**æµ‹è¯•æµç¨‹**ï¼š
1. ğŸ“§ å‘é€éªŒè¯ç åˆ°æµ‹è¯•é‚®ç®±
2. ğŸ”‘ è¾“å…¥éªŒè¯ç ç™»å½•ï¼Œè·å– token
3. ğŸ“Š æŸ¥çœ‹åˆå§‹è®¡è´¹ä¿¡æ¯
4. ğŸ“¦ åˆ‡æ¢åˆ° STARTER å¥—é¤
5. ğŸ“¦ åˆ‡æ¢åˆ° PRO å¥—é¤
6. ğŸ’¸ æ¶ˆè€— 100 ç®—åŠ›
7. ğŸ’° å¢åŠ  500 ç®—åŠ›
8. ğŸ¯ åˆ‡æ¢åˆ° ULTIMATE å¥—é¤

### æ–¹æ³• 2: æ‰‹åŠ¨æµ‹è¯•

#### Step 1: ç™»å½•è·å– token

```bash
# å‘é€éªŒè¯ç 
curl -X POST http://localhost:8000/api/v1/auth/send-code \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com"}'

# ä½¿ç”¨éªŒè¯ç ç™»å½•
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","code":"123456"}'
```

å“åº”ä¸­ä¼šåŒ…å« `access_token`ï¼Œå¤åˆ¶å®ƒã€‚

#### Step 2: æŸ¥çœ‹è®¡è´¹ä¿¡æ¯

```bash
curl -X GET http://localhost:8000/api/v1/billing/me \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

#### Step 3: åˆ‡æ¢å¥—é¤

```bash
# åˆ‡æ¢åˆ° PRO å¥—é¤
curl -X POST http://localhost:8000/api/v1/billing/change_plan \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -H "Content-Type: application/json" \
  -d '{"plan_id":"pro"}'
```

#### Step 4: å†æ¬¡æŸ¥çœ‹è®¡è´¹ä¿¡æ¯

```bash
curl -X GET http://localhost:8000/api/v1/billing/me \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

### æ–¹æ³• 3: ä½¿ç”¨ Swagger UI

1. æ‰“å¼€ http://localhost:8000/docs
2. æ‰¾åˆ° **billing** æ ‡ç­¾
3. ç‚¹å‡» ğŸ”“ **Authorize** æŒ‰é’®
4. è¾“å…¥ tokenï¼š`Bearer YOUR_TOKEN_HERE`
5. æµ‹è¯•å„ä¸ªæ¥å£

---

## ğŸ¯ å‰ç«¯é›†æˆç¤ºä¾‹

### 1. åˆ›å»ºè®¡è´¹ APIï¼ˆ`frontend/src/api/billing.ts`ï¼‰

```typescript
import { apiClient } from './client'

export interface UserBillingInfo {
  user_id: string
  email: string
  current_plan_id: string | null
  current_plan_name: string | null
  current_credits: number
  monthly_credits: number
  total_credits_used: number
  plan_renew_at: string | null
  credits_usage_percentage: number
}

export interface ChangePlanRequest {
  plan_id: string
}

export interface ChangePlanResponse {
  success: boolean
  message: string
  new_plan_id: string
  new_plan_name: string
  new_credits: number
  plan_renew_at: string
}

// è·å–å½“å‰ç”¨æˆ·è®¡è´¹ä¿¡æ¯
export async function getMyBillingInfo(): Promise<UserBillingInfo> {
  const response = await apiClient.get('/billing/me')
  return response.data
}

// åˆ‡æ¢å¥—é¤
export async function changePlan(planId: string): Promise<ChangePlanResponse> {
  const response = await apiClient.post('/billing/change_plan', { plan_id: planId })
  return response.data
}
```

### 2. åœ¨ LandingPage ä¸­ä½¿ç”¨

```typescript
import { changePlan } from '../api/billing'

// åˆ‡æ¢å¥—é¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
const handleSelectPlan = async (planId: string) => {
  try {
    const result = await changePlan(planId)
    alert(`${result.message}ï¼æ–°ç®—åŠ›: ${result.new_credits}`)
    
    // è·³è½¬åˆ°å·¥ä½œå°
    navigate('/editor')
  } catch (error) {
    console.error('åˆ‡æ¢å¥—é¤å¤±è´¥:', error)
    alert('è¯·å…ˆç™»å½•')
  }
}

// åœ¨æŒ‰é’®ä¸Šç»‘å®š
<button
  onClick={() => handleSelectPlan('pro')}
  className="btn-primary w-full mb-6"
>
  é€‰æ‹©æ–¹æ¡ˆ
</button>
```

### 3. æ˜¾ç¤ºç”¨æˆ·ç®—åŠ›ä¿¡æ¯

```typescript
import { useEffect, useState } from 'react'
import { getMyBillingInfo, type UserBillingInfo } from '../api/billing'

export default function UserCreditsDisplay() {
  const [billing, setBilling] = useState<UserBillingInfo | null>(null)

  useEffect(() => {
    getMyBillingInfo().then(data => {
      setBilling(data)
    }).catch(err => {
      console.error('è·å–è®¡è´¹ä¿¡æ¯å¤±è´¥:', err)
    })
  }, [])

  if (!billing) return null

  return (
    <div className="card">
      <h3>å¥—é¤ä¿¡æ¯</h3>
      <div>å½“å‰å¥—é¤: {billing.current_plan_name}</div>
      <div>å‰©ä½™ç®—åŠ›: {billing.current_credits} / {billing.monthly_credits}</div>
      
      {/* è¿›åº¦æ¡ */}
      <div className="w-full bg-dark-border rounded-full h-2">
        <div
          className="bg-primary h-2 rounded-full"
          style={{ width: `${billing.credits_usage_percentage}%` }}
        ></div>
      </div>
      
      <div className="text-sm text-text-tertiary">
        ä½¿ç”¨äº† {billing.credits_usage_percentage.toFixed(1)}%
      </div>
      <div className="text-sm text-text-tertiary">
        ä¸‹æ¬¡ç»­è´¹: {new Date(billing.plan_renew_at).toLocaleDateString()}
      </div>
    </div>
  )
}
```

---

## ğŸ“Š æ•°æ®æµç¨‹

### ç”¨æˆ·åˆ‡æ¢å¥—é¤æµç¨‹

```
å‰ç«¯                    åç«¯                    Redis
  |                      |                       |
  | POST /change_plan    |                       |
  |--------------------->|                       |
  |                      | éªŒè¯ token            |
  |                      | è·å– user_id          |
  |                      |                       |
  |                      | get_user(user_id)     |
  |                      |--------------------->|
  |                      |<---------------------|
  |                      | éªŒè¯å¥—é¤ ID            |
  |                      | æ›´æ–° plan_id          |
  |                      | é‡ç½® credits          |
  |                      | è®¾ç½® renew_at         |
  |                      |                       |
  |                      | save_user(user)       |
  |                      |--------------------->|
  |<---------------------|                       |
  | è¿”å›æ–°å¥—é¤ä¿¡æ¯         |                       |
```

### ç®—åŠ›æ¶ˆè€—æµç¨‹

```
ä»»åŠ¡å¤„ç†                è®¡è´¹æœåŠ¡               Redis
  |                      |                     |
  | consume_credits(100) |                     |
  |--------------------->|                     |
  |                      | get_user()          |
  |                      |-------------------->|
  |                      |<--------------------|
  |                      | æ£€æŸ¥ä½™é¢            |
  |                      | credits -= 100      |
  |                      | total_used += 100   |
  |                      |                     |
  |                      | save_user()         |
  |                      |-------------------->|
  |<---------------------|                     |
  | è¿”å›å‰©ä½™ç®—åŠ›          |                     |
```

---

## ğŸ”„ è‡ªåŠ¨ç»­è´¹é€»è¾‘ï¼ˆæœªæ¥ï¼‰

å½“å‰å®ç°äº†åŸºç¡€æ¡†æ¶ï¼Œæœªæ¥å¯ä»¥æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼š

```python
# ä¼ªä»£ç 
async def check_all_users_renewal():
    """å®šæ—¶æ£€æŸ¥æ‰€æœ‰ç”¨æˆ·æ˜¯å¦éœ€è¦ç»­è´¹"""
    all_users = get_all_users()
    
    for user in all_users:
        if billing_service.check_and_renew_plan(user.user_id):
            # ç»­è´¹æˆåŠŸï¼Œå‘é€é€šçŸ¥
            send_email(user.email, "æ‚¨çš„å¥—é¤å·²è‡ªåŠ¨ç»­è´¹")
```

---

## âœ… éªŒè¯æ¸…å•

- [x] æ‰©å±• User æ¨¡å‹ï¼Œæ·»åŠ å¥—é¤å­—æ®µ
- [x] åˆ›å»ºè®¡è´¹ Pydantic æ¨¡å‹
- [x] å®ç° BillingService æœåŠ¡
- [x] å®ç° `get_user_billing_info()` æ–¹æ³•
- [x] å®ç° `change_plan()` æ–¹æ³•
- [x] å®ç° `consume_credits()` æ–¹æ³•
- [x] å®ç° `add_credits()` æ–¹æ³•
- [x] åˆ›å»º `GET /billing/me` æ¥å£
- [x] åˆ›å»º `POST /billing/change_plan` æ¥å£
- [x] åœ¨ main.py æ³¨å†Œè·¯ç”±
- [x] åˆ›å»ºæµ‹è¯•è„šæœ¬
- [x] ç¼–å†™è¯¦ç»†æ–‡æ¡£

---

## ğŸ‰ å®Œæˆï¼

ç”¨æˆ·å¥—é¤ä½“ç³»å·²æˆåŠŸå®ç°ï¼ç°åœ¨å¯ä»¥ï¼š

1. âœ… ç”¨æˆ·ç™»å½•åæŸ¥çœ‹è‡ªå·±çš„å¥—é¤å’Œç®—åŠ›
2. âœ… ç”¨æˆ·å¯ä»¥åˆ‡æ¢å¥—é¤ï¼ˆMVP é˜¶æ®µæ— éœ€æ”¯ä»˜ï¼‰
3. âœ… ç³»ç»Ÿå¯ä»¥æ¶ˆè€—å’Œå¢åŠ ç”¨æˆ·ç®—åŠ›
4. âœ… è®°å½•ç´¯è®¡ä½¿ç”¨ç®—åŠ›
5. âœ… è®¾ç½®è‡ªåŠ¨ç»­è´¹æ—¶é—´

**ä¸‹ä¸€æ­¥å¯ä»¥**ï¼š
- ğŸ¨ å‰ç«¯é›†æˆï¼šæ˜¾ç¤ºç®—åŠ›ã€åˆ‡æ¢å¥—é¤
- ğŸ’³ æ”¯ä»˜é›†æˆï¼šæ¥å…¥çœŸå®æ”¯ä»˜
- ğŸ“§ é€šçŸ¥ç³»ç»Ÿï¼šç»­è´¹æé†’ã€ç®—åŠ›ä¸è¶³æé†’
- ğŸ“Š æ•°æ®ç»Ÿè®¡ï¼šä½¿ç”¨åˆ†æã€å¥—é¤è½¬åŒ–ç‡

