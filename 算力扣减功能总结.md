# 算力扣减功能总结

## ✅ 已完成

成功实现了**算力扣减与 AI 任务集成**，让套餐与 AI 调用次数真正关联。

---

## 🎯 核心改动

### 1. 算力消耗配置（`backend/app/config/credits_cost.py`）

- ✅ 定义基础算力消耗：换头 40 / 换背景 30 / 换姿势 50
- ✅ 定义质量加成：标准 1.0x / 高清 1.5x / 超高清 2.0x
- ✅ 定义尺寸加成：小图 1.0x / 中图 1.2x / 大图 1.5x / 超大图 2.0x
- ✅ 提供算力计算函数 `calculate_task_credits()`

**示例算力消耗**：
```
HEAD_SWAP + standard + medium = 40 × 1.0 × 1.2 = 48 算力
BACKGROUND_CHANGE + high + large = 30 × 1.5 × 1.5 = 68 算力
POSE_CHANGE + ultra + xlarge = 50 × 2.0 × 2.0 = 200 算力
```

### 2. 任务创建添加算力检查（`backend/app/api/v1/routes_tasks.py`）

- ✅ 添加用户认证（需要登录）
- ✅ 创建任务前计算所需算力
- ✅ 检查用户算力是否足够
- ✅ 算力不足返回 402 错误 `CREDIT_NOT_ENOUGH`
- ✅ 预扣除算力（成功后扣除）
- ✅ 创建失败自动返还算力
- ✅ 在任务信息中记录消耗的算力

**关键流程**：
```
创建任务 → 验证登录 → 计算算力 → 检查余额 → 预扣除 → 创建任务 → 返回结果
                                      ↓
                                  算力不足？
                                      ↓
                              返回 402 错误
```

### 3. 任务模型扩展（`backend/app/schemas/task.py`）

- ✅ `TaskInfo` 添加 `credits_consumed` 字段
- ✅ 前端可以看到每个任务消耗了多少算力

### 4. 测试和文档

- ✅ `test_credits_integration.py` - 自动化测试脚本
- ✅ `算力扣减与AI任务集成说明.md` - 详细技术文档
- ✅ `快速测试算力扣减.txt` - 快速测试指南
- ✅ `README.md` - 更新项目简介

---

## 📊 套餐使用次数对照

假设使用标准配置（HEAD_SWAP + 标准 + 中图 = 48 算力/次）：

| 套餐 | 月度算力 | 可用次数 | 价格 |
|------|---------|---------|------|
| STARTER | 2000 | ~41 次 | ¥49 |
| BASIC | 5000 | ~104 次 | ¥99 |
| PRO | 12000 | ~250 次 | ¥199 |
| ULTIMATE | 30000 | ~625 次 | ¥399 |

---

## 🔐 安全机制

1. **必须登录**：创建任务需要有效的 JWT token
2. **预扣除**：任务创建前先扣除算力，防止并发滥用
3. **自动返还**：任务创建失败时自动返还算力
4. **详细错误**：算力不足时返回详细错误信息（需要多少、当前多少、缺多少）

---

## 🎨 前端集成要点

### 1. 创建任务前显示预估算力
```typescript
<button className="btn-primary">
  生成（消耗 {estimateCredits(mode, quality, size)} 算力）
</button>
```

### 2. 处理 402 算力不足错误
```typescript
if (error.response?.status === 402) {
  const detail = error.response.data.detail
  alert(`算力不足！还差 ${detail.deficit} 算力`)
  // 引导用户升级套餐
}
```

### 3. 实时显示剩余算力
```typescript
<div className="credits-display">
  剩余算力: {credits} / {total}
  <ProgressBar percentage={(credits/total)*100} />
</div>
```

---

## 🧪 测试方法

### 快速测试（推荐）
```bash
cd backend
python test_credits_integration.py
```

### 手动测试
1. 登录获取 token
2. 切换到 PRO 套餐（12000 算力）
3. 创建任务 → 查看算力减少
4. 消耗算力到只剩 30
5. 尝试创建任务 → 返回 402 错误

---

## 📝 API 变化

### `POST /api/v1/tasks` - 创建任务

**新增要求**：
- ✅ 需要登录（`Authorization: Bearer <token>`）
- ✅ 会检查算力
- ✅ 会扣除算力

**新增响应字段**：
```json
{
  "task_id": "task_123",
  "credits_consumed": 48,  // 新增
  ...
}
```

**新增错误码**：
```
402 Payment Required - 算力不足
{
  "detail": {
    "error": "CREDIT_NOT_ENOUGH",
    "message": "算力不足。需要 48 算力，当前剩余 30 算力",
    "required": 48,
    "current": 30,
    "deficit": 18
  }
}
```

---

## 🎯 实现效果

### ✅ 用户视角
1. 选择套餐 → 获得对应算力
2. 创建 AI 任务 → 自动扣除算力
3. 算力不足 → 提示升级套餐
4. 查看剩余算力 → 实时显示

### ✅ 系统视角
1. 任务创建前验证算力
2. 预扣除机制防止滥用
3. 失败自动返还保证公平
4. 详细日志便于排查

---

## 🔄 数据流

```
用户点击"生成"
       ↓
前端: POST /tasks (带 token)
       ↓
后端: 验证 token → 获取 user_id
       ↓
后端: 计算所需算力 (48)
       ↓
后端: 查询用户剩余算力 (12000)
       ↓
后端: 检查是否足够 (12000 >= 48) ✓
       ↓
后端: 扣除算力 (12000 - 48 = 11952)
       ↓
后端: 创建任务
       ↓
前端: 收到任务信息 + credits_consumed
       ↓
前端: 更新 UI 显示剩余算力
```

---

## 📚 相关文件

| 文件 | 说明 |
|------|------|
| `backend/app/config/credits_cost.py` | 算力消耗配置 |
| `backend/app/api/v1/routes_tasks.py` | 任务创建逻辑（含算力检查） |
| `backend/app/schemas/task.py` | TaskInfo 模型 |
| `backend/test_credits_integration.py` | 自动化测试 |
| `算力扣减与AI任务集成说明.md` | 详细技术文档 |
| `快速测试算力扣减.txt` | 快速测试指南 |

---

## 🎉 完成！

现在 Formy 已经实现了**完整的套餐和算力系统**：

1. ✅ 用户注册和登录
2. ✅ 套餐配置和切换
3. ✅ 算力管理和扣除
4. ✅ AI 任务与算力绑定

**下一步建议**：
- 🎨 前端集成算力显示和错误处理
- 💳 接入真实支付系统
- 📧 添加算力预警和续费提醒
- 📊 添加使用统计和数据分析

套餐、算力、AI 任务已完全打通！💪✨

